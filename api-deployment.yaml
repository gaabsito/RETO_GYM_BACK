apiVersion: v1
kind: ConfigMap
metadata:
  name: gymapi-config
data:
  appsettings.json: |
    {
      "Logging": {
        "LogLevel": {
          "Default": "Information",
          "Microsoft.AspNetCore": "Warning"
        }
      },
      "AllowedHosts": "*",
      "ConnectionStrings": {
        "GymappDB": "Server=database-1.cgb9idzyd48b.us-east-1.rds.amazonaws.com;Database=GymappDB;User Id=sa;Password=YourStrongPassw0rd;TrustServerCertificate=True;"
      },
      "JwtSettings": {
        "SecretKey": "zxT3u9n6f8p1m4k7LQJHGFDSAWERTY_secureKey_2024",
        "ExpirationMinutes": 1440
      },
      "EmailSettings": {
        "SmtpServer": "smtp.gmail.com",
        "SmtpPort": 587,
        "SmtpUsername": "entrenategymapp@gmail.com",
        "SmtpPassword": "pzzb qmpb jbtr iqgf",
        "FromEmail": "entrenategymapp@gmail.com",
        "FromName": "ENTRÉNATE"
      },
      "CloudinarySettings": {
        "CloudName": "dloumvswa",
        "ApiKey": "164615966552187",
        "ApiSecret": "pcFx08vvNdisaGHh-qNl1CuQsGE"
      },
      "Authentication": {
        "Google": {
          "ClientId": "1088462991637-hqvnr9hmlqpv6lfin0sga0o1h5k4kv21.apps.googleusercontent.com",
          "ClientSecret": "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"
        }
      },
      "FrontendUrl": "https://entrenate.retocsv.es"
    }

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gymapi-deployment
  labels:
    app: gymapi
spec:
  replicas: 2
  selector:
    matchLabels:
      app: gymapi
  template:
    metadata:
      labels:
        app: gymapi
    spec:
      containers:
        - name: gymapi
          image: gaabsito/tfg:gymapi
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
          resources:
            limits:
              cpu: "1"
              memory: "512Mi"
            requests:
              cpu: "200m"
              memory: "256Mi"
          volumeMounts:
            - name: config-volume
              mountPath: /app/appsettings.json
              subPath: appsettings.json
          env:
            - name: ASPNETCORE_ENVIRONMENT
              value: "Production"
      volumes:
        - name: config-volume
          configMap:
            name: gymapi-config

---
apiVersion: v1
kind: Service
metadata:
  name: gymapi-service
  annotations:
    # Configuración SSL para el backend
    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: http
    service.beta.kubernetes.io/aws-load-balancer-ssl-cert: arn:aws:acm:us-east-1:626153274627:certificate/d5a9e43e-114f-4494-b56d-4b982e2f5890
    service.beta.kubernetes.io/aws-load-balancer-ssl-ports: "https"
    service.beta.kubernetes.io/aws-load-balancer-ssl-negotiation-policy: ELBSecurityPolicy-TLS-1-2-2017-01
spec:
  selector:
    app: gymapi
  ports:
    - name: http
      port: 80
      targetPort: 8080
      protocol: TCP
    - name: https
      port: 443
      targetPort: 8080
      protocol: TCP
  type: LoadBalancer